// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id          Int      @id @default(autoincrement())
  name        String
  username    String   @unique
  password_HACK String
  role        String   // 'Admin' or 'Cashier'
  
  // Relations
  transactions Transaction[]
  orderActivityLogs OrderActivityLog[]
  stockAdjustments StockAdjustment[]  // Add this line for the opposite relation
  
  @@map("users")
}

model Product {
  id         Int             @id @default(autoincrement())
  name       String
  categoryId Int
  variants   ProductVariant[]
  
  category Category @relation(fields: [categoryId], references: [id])
  
  @@map("products")
}

model ProductVariant {
  id               Int                    @id @default(autoincrement())
  productId        Int
  name             String
  price            Float
  isFavourite      Boolean? @default(false)
  backgroundColor String
  textColor        String
  stockConsumption StockConsumption[]
  
  product Product @relation(fields: [productId], references: [id])
  
  @@map("product_variants")
}

model StockConsumption {
  id         Int     @id @default(autoincrement())
  variantId  Int
  stockItemId Int
  quantity   Int
  
  variant    ProductVariant @relation(fields: [variantId], references: [id])
  stockItem  StockItem      @relation(fields: [stockItemId], references: [id])
  
  @@map("stock_consumptions")
}

model Category {
  id            Int     @id @default(autoincrement())
  name          String
  visibleTillIds Json?  // Array of till IDs as JSON
  
  products Product[]
  
  @@map("categories")
}

model Transaction {
  id         Int         @id @default(autoincrement())
  items      Json        // Array of order items as JSON
  subtotal   Float
  tax        Float
  tip        Float
  total      Float
  paymentMethod String
  userId     Int
  userName   String
  tillId     Int
  tillName   String
  createdAt  DateTime    @default(now())
  
  user User @relation(fields: [userId], references: [id])
  
  @@map("transactions")
}

model Tab {
  id         Int         @id @default(autoincrement())
  name       String
  items      Json        // Array of order items as JSON
  createdAt DateTime    @default(now())
  tillId     Int
 tillName   String
  
  @@map("tabs")
}

model Till {
  id   Int    @id @default(autoincrement())
  name String
  
  @@map("tills")
}

model StockItem {
  id              Int              @id @default(autoincrement())
  name            String
  quantity        Int
  type            String           // 'Ingredient' or 'Sellable Good'
  baseUnit        String
  purchasingUnits Json?            // Array of purchasing units as JSON
  
  stockConsumptions StockConsumption[]
  stockAdjustments StockAdjustment[]
  
  @@map("stock_items")
}

model StockAdjustment {
  id        Int      @id @default(autoincrement())
  stockItemId Int
  itemName  String
  quantity  Int      // Positive for additions, negative for subtractions
  reason    String
 userId    Int
 userName  String
 createdAt DateTime @default(now())
  
  stockItem StockItem @relation(fields: [stockItemId], references: [id])
  user      User      @relation(fields: [userId], references: [id])
  
  @@map("stock_adjustments")
}

model OrderActivityLog {
  id         Int      @id @default(autoincrement())
  action     String   // 'Item Removed' or 'Order Cleared'
  details    Json     // Details as JSON
  userId     Int
  userName   String
  createdAt  DateTime @default(now())
  
  user User @relation(fields: [userId], references: [id])
  
  @@map("order_activity_logs")
}

model Settings {
  id        Int     @id @default(autoincrement())
  taxMode   String  // 'inclusive', 'exclusive', or 'none'
  autoStartTime String // e.g., "06:00"
  lastManualClose DateTime?
  
  @@map("settings")
}