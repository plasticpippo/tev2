generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [uuid_ossp(map: "uuid-ossp")]
}

model User {
  id                Int                @id @default(autoincrement())
  name              String
  username          String             @unique
  password_HACK     String
  role              String
  dailyClosings     DailyClosing[]
  orderActivityLogs OrderActivityLog[]
  orderSessions     OrderSession[]
  stockAdjustments  StockAdjustment[]
  transactions      Transaction[]

  @@map("users")
}

model Product {
  id         Int              @id @default(autoincrement())
  name       String
  categoryId Int
  variants   ProductVariant[]
  category   Category         @relation(fields: [categoryId], references: [id])

  @@map("products")
}

model ProductVariant {
  id               Int                @id @default(autoincrement())
  productId        Int
  name             String
  price            Float
  isFavourite      Boolean?           @default(false)
  backgroundColor  String
  textColor        String
  product          Product            @relation(fields: [productId], references: [id])
  stockConsumption StockConsumption[]
  variantLayouts   VariantLayout[]
  sharedLayoutPositions SharedLayoutPosition[]

  @@map("product_variants")
}



model StockConsumption {
  id          Int            @id @default(autoincrement())
  variantId   Int
  quantity    Int
  stockItemId String         @db.Uuid
  stockItem   StockItem      @relation(fields: [stockItemId], references: [id])
  variant     ProductVariant @relation(fields: [variantId], references: [id])

  @@map("stock_consumptions")
}

model Category {
  id                 Int                 @id @default(autoincrement())
  name               String
  visibleTillIds     Json?
  products           Product[]
  sharedLayouts      SharedLayout[]

  @@map("categories")
}

model Transaction {
  id            Int      @id @default(autoincrement())
  items         Json
  subtotal      Float
  tax           Float
  tip           Float
  total         Float
  paymentMethod String
  userId        Int
  userName      String
  tillId        Int
  tillName      String
  createdAt     DateTime @default(now())
  user          User     @relation(fields: [userId], references: [id])

  @@map("transactions")
}

model Room {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  tables      Table[]

  @@map("rooms")
}

model Table {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name      String
  x         Float    @default(0)
  y         Float    @default(0)
  width     Float    @default(100)
  height    Float    @default(100)
  status    String   @default("available")
  roomId    String   @db.Uuid
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  room      Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)
  tabs      Tab[]

  @@index([roomId])
  @@map("tables")
}

model Tab {
  id        Int      @id @default(autoincrement())
  name      String
  items     Json
  createdAt DateTime @default(now())
  tillId    Int
  tillName  String
  tableId   String?  @db.Uuid
  table     Table?   @relation(fields: [tableId], references: [id])

  @@index([tableId])
  @@map("tabs")
}

model Till {
  id                 Int                 @id @default(autoincrement())
  name               String
  variantLayouts     VariantLayout[]

  @@map("tills")
}

model StockItem {
  name              String
  quantity          Int
  type              String
  baseUnit          String
  purchasingUnits   Json?
  id                String             @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  stockAdjustments  StockAdjustment[]
  stockConsumptions StockConsumption[]

  @@map("stock_items")
}

model StockAdjustment {
  id          Int       @id @default(autoincrement())
  itemName    String
  quantity    Int
  reason      String
  userId      Int
  userName    String
  createdAt   DateTime  @default(now())
  stockItemId String    @db.Uuid
  stockItem   StockItem @relation(fields: [stockItemId], references: [id])
  user        User      @relation(fields: [userId], references: [id])

  @@map("stock_adjustments")
}

model OrderActivityLog {
  id        Int      @id @default(autoincrement())
  action    String
  details   Json
  userId    Int
  userName  String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])

  @@map("order_activity_logs")
}

model Settings {
  id              Int       @id @default(autoincrement())
  taxMode         String
  autoStartTime   String
  lastManualClose DateTime?

  @@map("settings")
}

model DailyClosing {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  closedAt  DateTime
  summary   Json
  userId    Int
  user      User     @relation(fields: [userId], references: [id])

  @@map("daily_closings")
}

model OrderSession {
  id         String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId     Int
  items      Json
  status     String
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  logoutTime DateTime?
  user       User      @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@map("order_sessions")
}

model VariantLayout {
  id         Int      @id @default(autoincrement())
  tillId     Int
  categoryId Int
  variantId  Int
  gridColumn Int      // 1-4 for 4-column grid
  gridRow    Int      // 1-based row number
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  till       Till     @relation(fields: [tillId], references: [id], onDelete: Cascade)
  variant    ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)
  // Removed category relation to allow pseudo-categories like Favourites (categoryId -1)
  
  @@unique([tillId, categoryId, variantId])
  @@index([tillId, categoryId])
  @@map("variant_layouts")
}

model SharedLayout {
  id         Int                    @id @default(autoincrement())
  name       String
  categoryId Int
  createdAt  DateTime               @default(now())
  updatedAt  DateTime               @updatedAt
  
  category   Category               @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  positions  SharedLayoutPosition[]
  
  @@map("shared_layouts")
}

model SharedLayoutPosition {
  id              Int          @id @default(autoincrement())
  sharedLayoutId  Int
  variantId       Int
  gridColumn      Int          // 1-4 for 4-column grid
  gridRow         Int          // 1-based row number
  
  sharedLayout    SharedLayout @relation(fields: [sharedLayoutId], references: [id], onDelete: Cascade)
  variant         ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)
  
  @@unique([sharedLayoutId, variantId])
  @@index([sharedLayoutId])
  @@map("shared_layout_positions")
}




