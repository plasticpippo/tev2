# Rollback Procedures

**Purpose:** Step-by-step instructions to revert changes if issues occur  
**Last Updated:** 2026-02-11

---

## Overview

This document provides detailed rollback procedures for each phase of the vulnerability remediation. Use these procedures if verification fails or if the application becomes unstable after applying updates.

---

## Rollback Decision Matrix

| Scenario | Action | Complexity |
|----------|--------|------------|
| npm audit fix fails | Try alternative fix method | Low |
| Tests fail after update | Debug first, then consider rollback | Medium |
| Server won't start | Check logs, then consider rollback | Medium |
| Build fails | Clear caches first, then consider rollback | Low |
| Application unstable in production | Immediate rollback | High |
| Multiple issues after update | Full rollback to backup branch | High |

---

## Pre-Rollback Checklist

Before initiating a rollback:

- [ ] Document the issue encountered
- [ ] Save any error messages or logs
- [ ] Determine which phase caused the issue
- [ ] Check if a simple fix is available
- [ ] Verify backup branch exists

---

## Phase 1 Rollback: Backend Safe Upgrades

### Quick Rollback (Recommended)

Use this if Phase 1 fails and you want to revert quickly:

- [ ] **R.1.1:** Navigate to backend directory
  ```bash
  cd backend
  ```

- [ ] **R.1.2:** Discard package changes
  ```bash
  git checkout package.json package-lock.json
  ```

- [ ] **R.1.3:** Remove node_modules
  ```bash
  rm -rf node_modules
  ```

- [ ] **R.1.4:** Reinstall original dependencies
  ```bash
  npm install
  ```

- [ ] **R.1.5:** Verify rollback successful
  ```bash
  npm audit
  npm test
  ```

### Full Rollback from Backup Branch

Use this if quick rollback doesn't work:

- [ ] **R.1.6:** List all branches
  ```bash
  git branch -a
  ```

- [ ] **R.1.7:** Checkout backup branch
  ```bash
  git checkout fix/vulnerability-phase1-backup
  ```

- [ ] **R.1.8:** Create new branch from backup
  ```bash
  git checkout -b fix/vulnerability-phase1-restored
  ```

- [ ] **R.1.9:** Navigate to backend
  ```bash
  cd backend
  ```

- [ ] **R.1.10:** Clean install
  ```bash
  rm -rf node_modules
  npm install
  ```

- [ ] **R.1.11:** Verify rollback
  ```bash
  npm audit
  npm test
  npm run dev
  ```

### Manual Package Version Revert

Use this if you need to revert specific packages:

- [ ] **R.1.12:** Install specific axios version
  ```bash
  npm install axios@1.13.3
  ```

- [ ] **R.1.13:** Install specific express version
  ```bash
  npm install express@4.21.2
  ```

- [ ] **R.1.14:** Reinstall all dependencies
  ```bash
  rm -rf node_modules package-lock.json
  npm install
  ```

---

## Phase 2 Rollback: Frontend Safe Upgrades

### Quick Rollback (Recommended)

- [ ] **R.2.1:** Navigate to frontend directory
  ```bash
  cd frontend
  ```

- [ ] **R.2.2:** Discard package changes
  ```bash
  git checkout package.json package-lock.json
  ```

- [ ] **R.2.3:** Remove node_modules
  ```bash
  rm -rf node_modules
  ```

- [ ] **R.2.4:** Reinstall original dependencies
  ```bash
  npm install
  ```

- [ ] **R.2.5:** Verify rollback successful
  ```bash
  npm audit
  npm test
  npm run build
  ```

### Full Rollback from Backup Branch

- [ ] **R.2.6:** Checkout backup branch
  ```bash
  git checkout fix/vulnerability-phase2-backup
  ```

- [ ] **R.2.7:** Create new branch from backup
  ```bash
  git checkout -b fix/vulnerability-phase2-restored
  ```

- [ ] **R.2.8:** Navigate to frontend
  ```bash
  cd frontend
  ```

- [ ] **R.2.9:** Clean install
  ```bash
  rm -rf node_modules
  npm install
  ```

- [ ] **R.2.10:** Verify rollback
  ```bash
  npm audit
  npm test
  npm run build
  npm run dev
  ```

---

## Phase 3 Rollback: Vitest Major Upgrade

### Quick Rollback (Recommended)

- [ ] **R.3.1:** Navigate to frontend directory
  ```bash
  cd frontend
  ```

- [ ] **R.3.2:** Restore vitest config backup
  ```bash
  mv vitest.config.ts.backup vitest.config.ts
  ```
  Or if backup doesn't exist:
  ```bash
  git checkout vitest.config.ts
  ```

- [ ] **R.3.3:** Discard package changes
  ```bash
  git checkout package.json package-lock.json
  ```

- [ ] **R.3.4:** Remove node_modules and caches
  ```bash
  rm -rf node_modules
  rm -rf node_modules/.vitest
  rm -rf node_modules/.vite
  ```

- [ ] **R.3.5:** Reinstall original dependencies
  ```bash
  npm install
  ```

- [ ] **R.3.6:** Verify rollback successful
  ```bash
  npm audit
  npm test
  npm run build
  ```

### Full Rollback from Backup Branch

- [ ] **R.3.7:** Checkout backup branch
  ```bash
  git checkout fix/vulnerability-phase3-backup
  ```

- [ ] **R.3.8:** Create new branch from backup
  ```bash
  git checkout -b fix/vulnerability-phase3-restored
  ```

- [ ] **R.3.9:** Navigate to frontend
  ```bash
  cd frontend
  ```

- [ ] **R.3.10:** Clean install
  ```bash
  rm -rf node_modules
  npm install
  ```

- [ ] **R.3.11:** Verify rollback
  ```bash
  npm audit
  npm test
  npm run build
  npm run dev
  ```

### Manual Vitest Package Revert

Use this to revert specific vitest packages:

- [ ] **R.3.12:** Install specific vitest version
  ```bash
  npm install vitest@1.0.0
  ```

- [ ] **R.3.13:** Install specific coverage package
  ```bash
  npm install @vitest/coverage-v8@1.0.0
  ```

- [ ] **R.3.14:** Install specific UI package
  ```bash
  npm install @vitest/ui@1.0.0
  ```

- [ ] **R.3.15:** Restore vitest config
  ```bash
  git checkout vitest.config.ts
  ```

---

## Complete Rollback: All Phases

Use this if you need to revert all changes across all phases:

### Method 1: Reset to Original State

- [ ] **R.A.1:** Check current branch
  ```bash
  git branch
  ```

- [ ] **R.A.2:** Find the commit before Phase 1
  ```bash
  git log --oneline -10
  ```
  Look for commits with messages about vulnerability fixes

- [ ] **R.A.3:** Reset to that commit
  ```bash
  git reset --hard <commit-hash>
  ```
  Replace `<commit-hash>` with the commit before Phase 1

- [ ] **R.A.4:** Reinstall all dependencies
  ```bash
  # Backend
  cd backend
  rm -rf node_modules
  npm install

  # Frontend
  cd ../frontend
  rm -rf node_modules
  npm install
  ```

- [ ] **R.A.5:** Verify rollback
  ```bash
  # Backend
  cd backend
  npm audit
  npm test

  # Frontend
  cd ../frontend
  npm audit
  npm test
  ```

### Method 2: Create New Branch from Main

- [ ] **R.A.6:** Fetch latest
  ```bash
  git fetch origin
  ```

- [ ] **R.A.7:** Checkout main/master
  ```bash
  git checkout main
  # or
  git checkout master
  ```

- [ ] **R.A.8:** Create new working branch
  ```bash
  git checkout -b fix/vulnerability-fresh-start
  ```

- [ ] **R.A.9:** Reinstall all dependencies
  ```bash
  # Backend
  cd backend && rm -rf node_modules && npm install

  # Frontend
  cd ../frontend && rm -rf node_modules && npm install
  ```

---

## Docker Environment Rollback

If using Docker and need to rollback:

- [ ] **R.D.1:** Stop all containers
  ```bash
  docker compose down
  ```

- [ ] **R.D.2:** Remove volumes if needed
  ```bash
  docker compose down -v
  ```
  Warning: This removes database data

- [ ] **R.D.3:** Revert code changes first (see above)

- [ ] **R.D.4:** Rebuild containers
  ```bash
  docker compose up -d --build
  ```

- [ ] **R.D.5:** Check container status
  ```bash
  docker compose ps
  ```

- [ ] **R.D.6:** Check container logs
  ```bash
  docker compose logs -f
  ```

---

## Post-Rollback Verification

After any rollback, verify the system is working:

### Backend Verification

- [ ] **R.V.1:** Backend audit shows expected vulnerabilities
  ```bash
  cd backend && npm audit
  ```
  Expected: Shows original vulnerabilities (5)

- [ ] **R.V.2:** Backend tests pass
  ```bash
  cd backend && npm test
  ```

- [ ] **R.V.3:** Backend server starts
  ```bash
  cd backend && npm run dev
  ```

### Frontend Verification

- [ ] **R.V.4:** Frontend audit shows expected vulnerabilities
  ```bash
  cd frontend && npm audit
  ```
  Expected: Shows original vulnerabilities (8)

- [ ] **R.V.5:** Frontend tests pass
  ```bash
  cd frontend && npm test
  ```

- [ ] **R.V.6:** Frontend builds
  ```bash
  cd frontend && npm run build
  ```

- [ ] **R.V.7:** Frontend server starts
  ```bash
  cd frontend && npm run dev
  ```

### Application Verification

- [ ] **R.V.8:** Docker containers running
  ```bash
  docker compose ps
  ```

- [ ] **R.V.9:** Application accessible in browser
  Navigate to: http://192.168.1.241:80

- [ ] **R.V.10:** Login works
  Test with admin/admin123

---

## Troubleshooting Rollback Issues

### Issue: git checkout fails with "cannot stat"

**Solution:**
```bash
# Files may be in use, stop servers first
# Then try again
git checkout package.json package-lock.json
```

### Issue: npm install fails after rollback

**Solution:**
```bash
# Clear npm cache
npm cache clean --force

# Remove all artifacts
rm -rf node_modules package-lock.json

# Fresh install
npm install
```

### Issue: Tests still fail after rollback

**Solution:**
```bash
# Clear test caches
rm -rf node_modules/.vitest
rm -rf node_modules/.vite

# Reinstall
npm install

# Run tests
npm test
```

### Issue: Docker containers won't start

**Solution:**
```bash
# Full reset
docker compose down -v
docker system prune -f

# Rebuild
docker compose up -d --build
```

### Issue: Backup branch not found

**Solution:**
```bash
# List all branches including remote
git branch -a

# If on remote, checkout
git checkout -b fix/vulnerability-phase1-backup origin/fix/vulnerability-phase1-backup
```

---

## Rollback Log Template

After performing a rollback, document the issue:

```
## Rollback Log Entry

**Date:** ___
**Phase Rolled Back:** ___
**Reason for Rollback:** ___
**Error Messages:** ___
**Steps Taken:** ___
**Time to Recover:** ___
**Lessons Learned:** ___
**Action Items to Prevent Recurrence:** ___
```

---

## Emergency Contacts

If rollback procedures fail and the system is critically impaired:

1. Check Docker container logs: `docker compose logs -f`
2. Check application logs in backend
3. Verify database connectivity
4. Consider restoring from a full backup if available

---

## Quick Reference Commands

| Action | Command |
|--------|---------|
| Discard package changes | `git checkout package.json package-lock.json` |
| Remove node_modules | `rm -rf node_modules` |
| Fresh npm install | `npm install` |
| Clear npm cache | `npm cache clean --force` |
| List backup branches | `git branch -a \| grep backup` |
| Reset to commit | `git reset --hard <commit>` |
| Stop Docker | `docker compose down` |
| Rebuild Docker | `docker compose up -d --build` |
| Check container status | `docker compose ps` |
| View container logs | `docker compose logs -f` |
