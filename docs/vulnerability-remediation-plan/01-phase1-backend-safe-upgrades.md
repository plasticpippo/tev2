# Phase 1: Backend Safe Upgrades

**Phase Risk Level:** LOW  
**Estimated Duration:** Quick  
**Prerequisites:** None

---

## Overview

This phase addresses all 5 backend vulnerabilities through safe, non-breaking patch/minor version updates. All fixes can be applied with `npm audit fix` without requiring code changes.

### Vulnerabilities Addressed

| Package | Severity | Current | Fixed | CVE/GHSA |
|---------|----------|---------|-------|----------|
| axios | High | 1.13.3 | >1.13.4 | GHSA-43fc-jf86-j433 |
| express | High | 4.21.2 | >4.21.2 | GHSA-6rw7-vpxm-498p |
| qs | High | 6.13.0/6.14.0 | >=6.14.1 | GHSA-6rw7-vpxm-498p |
| body-parser | High | 1.20.3 | >1.20.3 | GHSA-6rw7-vpxm-498p |
| js-yaml | Moderate | 3.14.1 | >=3.14.2 | GHSA-mh29-5h37-fv8m |

---

## Prerequisites

Before starting this phase, complete the following tasks:

### Pre-Phase Tasks

- [ ] **Task 1.0.1:** Verify git working directory is clean
  ```bash
  git status
  ```
  Expected: "nothing to commit, working tree clean" or only untracked files

- [ ] **Task 1.0.2:** Create backup branch for this phase
  ```bash
  git checkout -b fix/vulnerability-phase1-backup
  git checkout -
  ```
  This creates a backup branch you can return to if needed

- [ ] **Task 1.0.3:** Document current package versions
  ```bash
  cd backend && npm list axios express qs body-parser js-yaml --depth=0 2>/dev/null || true
  ```
  Record output for comparison later

- [ ] **Task 1.0.4:** Verify backend server can start
  ```bash
  cd backend && npm run dev
  ```
  Wait for server to start, then stop it with Ctrl+C

---

## Task Checklist

### Step 1: Run npm audit fix

- [ ] **Task 1.1.1:** Navigate to backend directory
  ```bash
  cd backend
  ```

- [ ] **Task 1.1.2:** Run npm audit to see current vulnerabilities
  ```bash
  npm audit
  ```
  Expected: Shows 5 vulnerabilities (4 high, 1 moderate)

- [ ] **Task 1.1.3:** Run npm audit fix
  ```bash
  npm audit fix
  ```
  Expected: Output shows "fixed 5 vulnerabilities" or similar

- [ ] **Task 1.1.4:** Verify npm audit shows 0 vulnerabilities
  ```bash
  npm audit
  ```
  Expected: "found 0 vulnerabilities"

### Step 2: Verify Package Updates

- [ ] **Task 1.2.1:** Check axios version updated
  ```bash
  npm list axios
  ```
  Expected: axios@1.13.5 or higher (must be >1.13.4)

- [ ] **Task 1.2.2:** Check express version updated
  ```bash
  npm list express
  ```
  Expected: express@4.22.0 or higher (must be >4.21.2)

- [ ] **Task 1.2.3:** Check qs version updated
  ```bash
  npm list qs
  ```
  Expected: qs@6.14.1 or higher

- [ ] **Task 1.2.4:** Check js-yaml version updated
  ```bash
  npm list js-yaml
  ```
  Expected: js-yaml@3.14.2 or higher

### Step 3: Run Tests

- [ ] **Task 1.3.1:** Run backend test suite
  ```bash
  npm test
  ```
  Expected: All tests pass

- [ ] **Task 1.3.2:** Verify no test errors or failures
  Check test output for:
  - No "FAIL" messages
  - No "Error:" messages
  - All tests show "PASS" or "✓"

### Step 4: Verify Application Starts

- [ ] **Task 1.4.1:** Start backend development server
  ```bash
  npm run dev
  ```

- [ ] **Task 1.4.2:** Wait for server startup confirmation
  Look for console output indicating:
  - Server listening on port
  - Database connection successful
  - No error messages

- [ ] **Task 1.4.3:** Stop the server
  Press Ctrl+C to stop the server gracefully

### Step 5: Commit Changes

- [ ] **Task 1.5.1:** Review changed files
  ```bash
  git status
  ```
  Expected: Shows package.json and package-lock.json modified

- [ ] **Task 1.5.2:** Stage the changes
  ```bash
  git add backend/package.json backend/package-lock.json
  ```

- [ ] **Task 1.5.3:** Commit the changes
  ```bash
  git commit -m "fix(security): resolve backend npm vulnerabilities - axios, express, qs, js-yaml"
  ```

---

## Expected Output

### Successful npm audit fix Output
```
added X packages, removed Y packages, changed Z packages, and audited 926 packages in 5s

found 0 vulnerabilities
```

### Successful npm audit Output
```
# npm audit report

found 0 vulnerabilities
```

### Successful Test Output
```
PASS src/__tests__/example.test.ts
  ✓ test description (X ms)

Test Suites: X passed, X total
Tests:       X passed, X total
```

---

## Risk Assessment

### What Could Go Wrong

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| npm audit fix fails | Low | Low | Run npm install manually |
| Tests fail after update | Low | Medium | Check error messages, may need minor code fix |
| Server fails to start | Low | Medium | Check for missing dependencies, run npm install |
| Lock file conflicts | Low | Low | Delete node_modules and package-lock.json, reinstall |

### Breaking Changes Analysis

**axios (1.13.3 → 1.13.5+):**
- Patch version upgrade
- No API changes
- No code modifications required

**express (4.21.2 → 4.22+):**
- Patch version upgrade
- Only dependency updates (qs, body-parser)
- No API changes
- No code modifications required

**qs (6.13.0 → 6.14.1+):**
- Patch version upgrade
- Security fix for arrayLimit bypass
- No API changes
- Transitive dependency - no direct usage

**js-yaml (3.14.1 → 3.14.2+):**
- Patch version upgrade
- Security fix for prototype pollution
- No API changes
- Transitive dependency - no direct usage

---

## Verification Steps

### Immediate Verification

1. **Audit Clean:** `npm audit` shows 0 vulnerabilities
2. **Tests Pass:** `npm test` completes without failures
3. **Server Starts:** `npm run dev` starts without errors

### Extended Verification (Optional)

If you want to be extra thorough:

- [ ] **Task 1.V.1:** Test API endpoint with curl
  ```bash
  curl http://localhost:3000/api/health
  ```
  Or any other endpoint your application exposes

- [ ] **Task 1.V.2:** Check database connectivity
  Make a request that requires database access

- [ ] **Task 1.V.3:** Review logs for errors
  Check console output for any warning or error messages

---

## Troubleshooting

### Issue: npm audit fix reports "unable to fix"

**Solution:**
```bash
# Try force fix
npm audit fix --force

# If still failing, manually update
npm install axios@latest express@latest
```

### Issue: Tests fail after update

**Solution:**
1. Check the specific test failure message
2. Run tests with verbose output: `npm test -- --verbose`
3. Check if any test uses deprecated API features
4. Review package changelogs for any undocumented changes

### Issue: Server fails to start

**Solution:**
```bash
# Clean install
rm -rf node_modules
npm install

# Check for missing peer dependencies
npm ls
```

### Issue: Lock file conflicts

**Solution:**
```bash
# Regenerate lock file
rm package-lock.json
npm install
```

---

## Rollback Procedure

If Phase 1 fails and you need to rollback:

### Quick Rollback
```bash
# Discard all changes
git checkout backend/package.json backend/package-lock.json

# Reinstall original dependencies
cd backend
rm -rf node_modules
npm install
```

### Full Rollback from Backup Branch
```bash
# Checkout backup branch
git checkout fix/vulnerability-phase1-backup

# Copy package files to current branch
git checkout - -- backend/package.json backend/package-lock.json

# Reinstall
cd backend
rm -rf node_modules
npm install
```

---

## Completion Criteria

Phase 1 is complete when:

- [ ] `npm audit` in backend shows 0 vulnerabilities
- [ ] All backend tests pass
- [ ] Backend server starts successfully
- [ ] Changes are committed to git
- [ ] No errors in application logs

---

## Next Phase

After completing Phase 1, proceed to:
- [Phase 2: Frontend Safe Upgrades](02-phase2-frontend-safe-upgrades.md)
