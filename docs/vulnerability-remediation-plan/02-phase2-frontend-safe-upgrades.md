# Phase 2: Frontend Safe Upgrades

**Phase Risk Level:** LOW  
**Estimated Duration:** Quick  
**Prerequisites:** Phase 1 completed successfully

---

## Overview

This phase addresses frontend vulnerabilities that can be fixed with non-breaking updates. These are primarily transitive dependencies that will be updated automatically via `npm audit fix`.

### Vulnerabilities Addressed

| Package | Severity | Current | Fixed | CVE/GHSA |
|---------|----------|---------|-------|----------|
| glob | High | 10.2.0-10.4.5 | >=10.5.0 | GHSA-5j98-mcp5-4vw2 |
| jws | High | 4.0.0 | !=4.0.0 | GHSA-869p-cjfg-cm3x |
| esbuild | Moderate | <=0.24.2 | >0.24.2 | GHSA-67mh-4wv8-2f99 |

### Vulnerabilities NOT Addressed in This Phase

The following vulnerabilities require major version upgrades and are addressed in Phase 3:
- vitest (1.x → 4.x)
- @vitest/coverage-v8 (1.x → 4.x)
- @vitest/ui (1.x → 4.x)
- vite (via vitest)
- vite-node (via vitest)

---

## Prerequisites

Before starting this phase, complete the following tasks:

### Pre-Phase Tasks

- [ ] **Task 2.0.1:** Verify Phase 1 is complete
  ```bash
  cd backend && npm audit
  ```
  Expected: "found 0 vulnerabilities"

- [ ] **Task 2.0.2:** Verify git working directory is clean
  ```bash
  git status
  ```
  Expected: Phase 1 changes committed, working tree clean

- [ ] **Task 2.0.3:** Create backup branch for this phase
  ```bash
  git checkout -b fix/vulnerability-phase2-backup
  git checkout -
  ```

- [ ] **Task 2.0.4:** Document current package versions
  ```bash
  cd frontend && npm list glob jws esbuild --depth=0 2>/dev/null || true
  ```
  Note: These may be transitive dependencies, so output might be empty

- [ ] **Task 2.0.5:** Verify frontend server can start
  ```bash
  cd frontend && npm run dev
  ```
  Wait for server to start, then stop with Ctrl+C

---

## Task Checklist

### Step 1: Run npm audit fix

- [ ] **Task 2.1.1:** Navigate to frontend directory
  ```bash
  cd frontend
  ```

- [ ] **Task 2.1.2:** Run npm audit to see current vulnerabilities
  ```bash
  npm audit
  ```
  Expected: Shows 8 vulnerabilities (2 high, 6 moderate)
  Note: This phase will fix glob, jws, and esbuild (3 vulnerabilities)

- [ ] **Task 2.1.3:** Run npm audit fix
  ```bash
  npm audit fix
  ```
  Expected: Output shows some vulnerabilities fixed

- [ ] **Task 2.1.4:** Check remaining vulnerabilities
  ```bash
  npm audit
  ```
  Expected: Shows fewer vulnerabilities (glob, jws, esbuild should be resolved)
  Note: vitest ecosystem vulnerabilities will remain - these are addressed in Phase 3

### Step 2: Verify Package Updates

- [ ] **Task 2.2.1:** Check if glob was updated
  ```bash
  npm list glob
  ```
  Expected: glob@10.5.0 or higher (if it was a direct/transitive dependency)

- [ ] **Task 2.2.2:** Check if jws was updated
  ```bash
  npm list jws
  ```
  Expected: jws@4.0.1 or higher, or any version !=4.0.0

- [ ] **Task 2.2.3:** Check if esbuild was updated
  ```bash
  npm list esbuild
  ```
  Expected: esbuild@0.25.0 or higher
  Note: This may not update if vitest pins an older version - that's OK for Phase 3

### Step 3: Run Tests

- [ ] **Task 2.3.1:** Run frontend test suite
  ```bash
  npm test
  ```
  Expected: All tests pass

- [ ] **Task 2.3.2:** Verify no test errors or failures
  Check test output for:
  - No "FAIL" messages
  - No "Error:" messages
  - All tests show "PASS" or "✓"

### Step 4: Verify Application Builds and Starts

- [ ] **Task 2.4.1:** Run production build
  ```bash
  npm run build
  ```
  Expected: Build completes without errors

- [ ] **Task 2.4.2:** Check build output
  Look for:
  - "built in X ms" message
  - No error messages
  - dist/ directory created

- [ ] **Task 2.4.3:** Start frontend development server
  ```bash
  npm run dev
  ```

- [ ] **Task 2.4.4:** Wait for server startup confirmation
  Look for console output indicating:
  - "VITE vX.X.X ready in X ms"
  - Local URL displayed
  - No error messages

- [ ] **Task 2.4.5:** Stop the server
  Press Ctrl+C to stop the server gracefully

### Step 5: Commit Changes

- [ ] **Task 2.5.1:** Review changed files
  ```bash
  git status
  ```
  Expected: Shows package.json and/or package-lock.json modified

- [ ] **Task 2.5.2:** Stage the changes
  ```bash
  git add frontend/package.json frontend/package-lock.json
  ```

- [ ] **Task 2.5.3:** Commit the changes
  ```bash
  git commit -m "fix(security): resolve frontend npm vulnerabilities - glob, jws, esbuild"
  ```

---

## Expected Output

### Successful npm audit fix Output
```
changed X packages, and audited X packages in Xs

X packages are looking for funding
  run `npm fund` for details

# npm audit report
[Remaining vitest vulnerabilities will be shown here]
```

### Successful Build Output
```
vite v6.2.0 building for production...
✓ X modules transformed.
dist/index.html                  X.XX kB │ gzip: X.XX kB
dist/assets/index-XXXXX.js       X.XX kB │ gzip: X.XX kB
✓ built in X.XXs
```

### Successful Dev Server Output
```
  VITE v6.2.0  ready in X ms

  ➜  Local:   http://localhost:3000/
  ➜  Network: use --host to expose
```

---

## Risk Assessment

### What Could Go Wrong

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| npm audit fix doesn't fix all | Medium | Low | Some fixes require --force (Phase 3) |
| Build fails after update | Low | Medium | Check build errors, may need config adjustment |
| Tests fail after update | Low | Medium | Review test failures, check for breaking changes |
| Dev server fails to start | Low | Medium | Check for missing dependencies |

### Breaking Changes Analysis

**glob (10.4.x → 10.5.0+):**
- Minor version upgrade
- CLI security fix only
- No programmatic API changes
- Transitive dependency - no direct usage

**jws (4.0.0 → 4.0.1+):**
- Patch version upgrade
- HMAC signature verification fix
- No API changes
- Transitive dependency - no direct usage

**esbuild (<=0.24.2 → 0.25.0+):**
- Minor version upgrade (0.x versioning)
- Dev server security fix
- May have minor config changes
- Used internally by Vite

---

## Verification Steps

### Immediate Verification

1. **Audit Improved:** `npm audit` shows fewer vulnerabilities
2. **Tests Pass:** `npm test` completes without failures
3. **Build Works:** `npm run build` completes successfully
4. **Dev Server Starts:** `npm run dev` starts without errors

### Extended Verification (Optional)

- [ ] **Task 2.V.1:** Test frontend in browser
  Open http://localhost:3000 and verify:
  - Page loads correctly
  - No console errors
  - Basic functionality works

- [ ] **Task 2.V.2:** Test login functionality
  - Login page appears
  - Can enter credentials
  - No JavaScript errors

- [ ] **Task 2.V.3:** Check for build warnings
  Review build output for any new warnings

---

## Troubleshooting

### Issue: npm audit fix doesn't fix glob/jws/esbuild

**Reason:** These may be pinned by vitest dependencies

**Solution:**
```bash
# Check what's holding back the update
npm ls glob
npm ls jws
npm ls esbuild

# If vitest is blocking, this is expected - will be fixed in Phase 3
```

### Issue: Build fails with esbuild errors

**Solution:**
```bash
# Clear Vite cache
rm -rf node_modules/.vite

# Rebuild
npm run build
```

### Issue: Dev server shows CORS errors

**Solution:**
This is unrelated to the security updates. Check vite.config.ts for CORS settings.

### Issue: Tests fail after update

**Solution:**
```bash
# Clear test cache
rm -rf node_modules/.vitest

# Run tests again
npm test
```

---

## Rollback Procedure

If Phase 2 fails and you need to rollback:

### Quick Rollback
```bash
# Discard all changes
git checkout frontend/package.json frontend/package-lock.json

# Reinstall original dependencies
cd frontend
rm -rf node_modules
npm install
```

### Full Rollback from Backup Branch
```bash
# Checkout backup branch
git checkout fix/vulnerability-phase2-backup

# Copy package files to current branch
git checkout - -- frontend/package.json frontend/package-lock.json

# Reinstall
cd frontend
rm -rf node_modules
npm install
```

---

## Completion Criteria

Phase 2 is complete when:

- [ ] `npm audit` in frontend shows fewer vulnerabilities (glob, jws, esbuild resolved)
- [ ] All frontend tests pass
- [ ] Frontend builds successfully
- [ ] Frontend dev server starts successfully
- [ ] Changes are committed to git
- [ ] No errors in application logs

**Note:** Some vulnerabilities (vitest ecosystem) will remain - these are addressed in Phase 3.

---

## Next Phase

After completing Phase 2, proceed to:
- [Phase 3: Vitest Major Upgrade](03-phase3-vitest-major-upgrade.md)
