# Phase 3: Vitest Major Upgrade

**Phase Risk Level:** HIGH  
**Estimated Duration:** Extended  
**Prerequisites:** Phase 1 and Phase 2 completed successfully

---

## Overview

This phase addresses the remaining frontend vulnerabilities by upgrading the vitest ecosystem from version 1.x to 4.x. This is a major version upgrade with breaking changes that require configuration file updates.

### Vulnerabilities Addressed

| Package | Severity | Current | Fixed | CVE/GHSA |
|---------|----------|---------|-------|----------|
| vitest | Moderate | ^1.0.0 | 4.0.18 | GHSA-67mh-4wv8-2f99 (via esbuild) |
| @vitest/coverage-v8 | Moderate | ^1.0.0 | 4.0.18 | GHSA-67mh-4wv8-2f99 (via esbuild) |
| @vitest/ui | Moderate | ^1.0.0 | 4.0.18 | GHSA-67mh-4wv8-2f99 (via esbuild) |
| vite | Moderate | 6.2.0 | >6.1.6 | GHSA-67mh-4wv8-2f99 (via esbuild) |
| vite-node | Moderate | via vitest | >2.2.0-beta.2 | GHSA-67mh-4wv8-2f99 (via esbuild) |
| esbuild | Moderate | <=0.24.2 | >0.24.2 | GHSA-67mh-4wv8-2f99 |

---

## Breaking Changes Summary

### 1. Coverage Configuration Changes

The `coverage.exclude` option behavior has changed. In v4.x:
- `node_modules` is excluded by default
- Use `coverage.include` to specify what to cover
- The `all` and `extensions` options were removed

### 2. Test Function Options Order (if applicable)

If any tests use options as a third argument:
```typescript
// Before (v1.x)
test('name', () => {}, { retry: 2 })

// After (v4.x)
test('name', { retry: 2 }, () => {})
```

### 3. Pool Options Migrated (if applicable)

Pool-specific options moved to top-level:
```typescript
// Before (v1.x)
poolOptions: { forks: { execArgv: ['--expose-gc'] } }

// After (v4.x)
execArgv: ['--expose-gc']
```

---

## Prerequisites

Before starting this phase, complete the following tasks:

### Pre-Phase Tasks

- [ ] **Task 3.0.1:** Verify Phase 1 is complete
  ```bash
  cd backend && npm audit
  ```
  Expected: "found 0 vulnerabilities"

- [ ] **Task 3.0.2:** Verify Phase 2 is complete
  ```bash
  cd frontend && npm audit
  ```
  Expected: Shows only vitest-related vulnerabilities (5 remaining)

- [ ] **Task 3.0.3:** Verify git working directory is clean
  ```bash
  git status
  ```
  Expected: Phase 1 and 2 changes committed, working tree clean

- [ ] **Task 3.0.4:** Create backup branch for this phase
  ```bash
  git checkout -b fix/vulnerability-phase3-backup
  git checkout -
  ```

- [ ] **Task 3.0.5:** Document current package versions
  ```bash
  cd frontend && npm list vitest @vitest/coverage-v8 @vitest/ui vite --depth=0
  ```
  Record output for comparison later

- [ ] **Task 3.0.6:** Run current tests to establish baseline
  ```bash
  cd frontend && npm test
  ```
  Note: Record the number of tests and their status

- [ ] **Task 3.0.7:** Backup current vitest.config.ts
  ```bash
  cp frontend/vitest.config.ts frontend/vitest.config.ts.backup
  ```

---

## Task Checklist

### Step 1: Update Vitest Packages

- [ ] **Task 3.1.1:** Navigate to frontend directory
  ```bash
  cd frontend
  ```

- [ ] **Task 3.1.2:** Run npm audit to see current vulnerabilities
  ```bash
  npm audit
  ```
  Expected: Shows vitest-related vulnerabilities

- [ ] **Task 3.1.3:** Update vitest to latest version
  ```bash
  npm install vitest@latest
  ```

- [ ] **Task 3.1.4:** Update @vitest/coverage-v8 to latest version
  ```bash
  npm install @vitest/coverage-v8@latest
  ```

- [ ] **Task 3.1.5:** Update @vitest/ui to latest version
  ```bash
  npm install @vitest/ui@latest
  ```

- [ ] **Task 3.1.6:** Verify package versions updated
  ```bash
  npm list vitest @vitest/coverage-v8 @vitest/ui
  ```
  Expected: All show version 4.x (4.0.18 or higher)

### Step 2: Update vitest.config.ts

- [ ] **Task 3.2.1:** Open vitest.config.ts for editing
  File location: `frontend/vitest.config.ts`

- [ ] **Task 3.2.2:** Update the import statement
  **Current (line 1):**
  ```typescript
  import { defineConfig } from 'vitest/config';
  ```
  **Change to:**
  ```typescript
  import { defineConfig, configDefaults } from 'vitest/config';
  ```

- [ ] **Task 3.2.3:** Update the coverage configuration
  **Current (lines 10-20):**
  ```typescript
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json', 'html'],
      exclude: [
        'node_modules',
        'src/test',
        'src/mocks',
        'vite.config.ts',
        'vitest.config.ts'
      ]
    }
  ```
  **Change to:**
  ```typescript
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json', 'html'],
      include: ['src/**/*.{js,jsx,ts,tsx}'],
      exclude: [
        'src/test',
        'src/mocks'
      ]
    }
  ```

- [ ] **Task 3.2.4:** Verify the complete updated file
  The complete updated file should look like:
  ```typescript
  import { defineConfig, configDefaults } from 'vitest/config';

  export default defineConfig({
    test: {
      environment: 'jsdom',
      setupFiles: ['./src/test/setup.ts'],
      globals: true,
      css: true,
      reporters: ['verbose'],
      coverage: {
        provider: 'v8',
        reporter: ['text', 'json', 'html'],
        include: ['src/**/*.{js,jsx,ts,tsx}'],
        exclude: [
          'src/test',
          'src/mocks'
        ]
      }
    },
    resolve: {
      alias: {
        '@': '/src',
      },
    },
  });
  ```

- [ ] **Task 3.2.5:** Save the file

### Step 3: Verify npm audit

- [ ] **Task 3.3.1:** Run npm audit to check vulnerabilities
  ```bash
  npm audit
  ```
  Expected: "found 0 vulnerabilities"

- [ ] **Task 3.3.2:** If vulnerabilities remain, check what's affected
  ```bash
  npm audit --json
  ```
  Look for any remaining vulnerability details

### Step 4: Run Tests

- [ ] **Task 3.4.1:** Clear vitest cache
  ```bash
  rm -rf node_modules/.vitest
  ```

- [ ] **Task 3.4.2:** Run frontend test suite
  ```bash
  npm test
  ```

- [ ] **Task 3.4.3:** Verify test count matches baseline
  Compare with Task 3.0.6 results:
  - Same number of test suites
  - Same number of tests
  - All tests pass

- [ ] **Task 3.4.4:** If tests fail, check error messages
  Look for:
  - Configuration errors
  - API changes affecting tests
  - Missing dependencies

### Step 5: Verify Application Builds

- [ ] **Task 3.5.1:** Run production build
  ```bash
  npm run build
  ```
  Expected: Build completes without errors

- [ ] **Task 3.5.2:** Check build output for warnings
  Look for any deprecation warnings or errors

- [ ] **Task 3.5.3:** Start development server
  ```bash
  npm run dev
  ```

- [ ] **Task 3.5.4:** Verify server starts correctly
  Look for:
  - "VITE vX.X.X ready in X ms"
  - No error messages

- [ ] **Task 3.5.5:** Stop the server
  Press Ctrl+C

### Step 6: Run Coverage Report (Optional)

- [ ] **Task 3.6.1:** Run tests with coverage
  ```bash
  npm run test:coverage
  ```
  Or if no script exists:
  ```bash
  npm test -- --coverage
  ```

- [ ] **Task 3.6.2:** Verify coverage report generates
  Look for:
  - Coverage table in console
  - coverage/ directory created
  - HTML report generated

### Step 7: Commit Changes

- [ ] **Task 3.7.1:** Review changed files
  ```bash
  git status
  ```
  Expected: Shows package.json, package-lock.json, and vitest.config.ts modified

- [ ] **Task 3.7.2:** Stage the changes
  ```bash
  git add frontend/package.json frontend/package-lock.json frontend/vitest.config.ts
  ```

- [ ] **Task 3.7.3:** Commit the changes
  ```bash
  git commit -m "fix(security): upgrade vitest to v4.x to resolve esbuild vulnerabilities"
  ```

- [ ] **Task 3.7.4:** Remove backup file
  ```bash
  rm frontend/vitest.config.ts.backup
  ```

---

## Expected Output

### Successful npm install Output
```
added X packages, removed Y packages, changed Z packages, and audited X packages in Xs

X packages are looking for funding
  run `npm fund` for details
```

### Successful npm audit Output
```
# npm audit report

found 0 vulnerabilities
```

### Successful Test Output
```
 ✓ src/__tests__/example.test.ts (X ms)

 Test Files  X passed (X)
      Tests  X passed (X)
   Start at  XX:XX:XX
   Duration  X.XXs (transform X ms, setup X ms, collect X ms, tests X ms, environment X ms, prepare X ms)
```

### Successful Coverage Output
```
 % Stmts   % Branch  % Funcs   % Lines  Uncovered Line Stmts
-----------|---------|----------|---------|-------------------
   X.XX      X.XX      X.XX      X.XX    ...
```

---

## Risk Assessment

### What Could Go Wrong

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Config migration incomplete | Medium | Medium | Follow exact file changes |
| Tests fail due to API changes | Medium | Medium | Check test syntax, update as needed |
| Coverage report format changes | Low | Low | Update CI scripts if needed |
| Build process affected | Low | Medium | Verify build still works |
| Peer dependency conflicts | Low | High | Check npm ls for conflicts |

### Breaking Changes Detail

**Coverage Configuration:**
- `coverage.all` option removed - now default behavior
- `coverage.extensions` removed - inferred from include patterns
- `coverage.exclude` no longer needs `node_modules` - excluded by default

**Test Function Signature:**
- Options moved from third to second parameter (rare usage)

**Pool Options:**
- `poolOptions.forks.*` moved to top-level
- `poolOptions.vmThreads.memoryLimit` → `vmMemoryLimit`

---

## Verification Steps

### Immediate Verification

1. **Audit Clean:** `npm audit` shows 0 vulnerabilities
2. **Tests Pass:** `npm test` completes without failures
3. **Build Works:** `npm run build` completes successfully
4. **Dev Server Starts:** `npm run dev` starts without errors

### Extended Verification

- [ ] **Task 3.V.1:** Test UI mode (if used)
  ```bash
  npm run test:ui
  ```
  Verify UI opens and tests run

- [ ] **Task 3.V.2:** Test watch mode
  ```bash
  npm test -- --watch
  ```
  Verify watch mode works, then stop with Ctrl+C

- [ ] **Task 3.V.3:** Verify coverage HTML report
  ```bash
  open coverage/index.html
  ```
  Or navigate to the file in browser

---

## Troubleshooting

### Issue: npm install fails with peer dependency errors

**Solution:**
```bash
# Check for conflicts
npm ls vitest @vitest/coverage-v8 @vitest/ui

# Force install if needed
npm install vitest@latest @vitest/coverage-v8@latest @vitest/ui@latest --force
```

### Issue: Tests fail with "configuration invalid"

**Solution:**
1. Check vitest.config.ts syntax
2. Ensure import includes `configDefaults` if used
3. Remove any deprecated options

### Issue: Coverage shows 0% for all files

**Solution:**
The `include` pattern may not match your files. Update:
```typescript
coverage: {
  include: ['src/**/*.{js,jsx,ts,tsx}'],
  // ...
}
```

### Issue: Tests fail with "test function signature changed"

**Solution:**
Find and update any tests using options as third argument:
```typescript
// Before
test('name', () => {}, { retry: 2 })

// After
test('name', { retry: 2 }, () => {})
```

### Issue: Build fails with Vite errors

**Solution:**
```bash
# Clear all caches
rm -rf node_modules/.vite
rm -rf node_modules/.vitest

# Rebuild
npm run build
```

### Issue: "Cannot find module" errors

**Solution:**
```bash
# Reinstall all dependencies
rm -rf node_modules
npm install
```

---

## Rollback Procedure

If Phase 3 fails and you need to rollback:

### Quick Rollback
```bash
# Restore original config
mv frontend/vitest.config.ts.backup frontend/vitest.config.ts

# Discard package changes
git checkout frontend/package.json frontend/package-lock.json

# Reinstall original dependencies
cd frontend
rm -rf node_modules
npm install
```

### Full Rollback from Backup Branch
```bash
# Checkout backup branch
git checkout fix/vulnerability-phase3-backup

# Copy files to current branch
git checkout - -- frontend/package.json frontend/package-lock.json frontend/vitest.config.ts

# Reinstall
cd frontend
rm -rf node_modules
npm install
```

---

## Completion Criteria

Phase 3 is complete when:

- [ ] `npm audit` in frontend shows 0 vulnerabilities
- [ ] All frontend tests pass
- [ ] Frontend builds successfully
- [ ] Frontend dev server starts successfully
- [ ] Coverage report generates correctly (if applicable)
- [ ] Changes are committed to git
- [ ] No errors in application logs

---

## Final Verification

After completing all three phases:

- [ ] **Task 3.F.1:** Run full backend audit
  ```bash
  cd backend && npm audit
  ```
  Expected: 0 vulnerabilities

- [ ] **Task 3.F.2:** Run full frontend audit
  ```bash
  cd frontend && npm audit
  ```
  Expected: 0 vulnerabilities

- [ ] **Task 3.F.3:** Run all backend tests
  ```bash
  cd backend && npm test
  ```

- [ ] **Task 3.F.4:** Run all frontend tests
  ```bash
  cd frontend && npm test
  ```

- [ ] **Task 3.F.5:** Start full application
  ```bash
  docker compose up -d --build
  ```

- [ ] **Task 3.F.6:** Verify application works in browser
  Navigate to http://192.168.1.241:80 and verify:
  - Login page loads
  - Can log in with admin/admin123
  - Basic functionality works

---

## Next Steps

After completing Phase 3:
- All npm vulnerabilities should be resolved
- Proceed to [Verification Checklist](04-verification-checklist.md)
- Review [Rollback Procedures](05-rollback-procedures.md) if needed
